<!DOCTYPE html>

<!-- implement pictures on the web page -->
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ocean Denmark Hang From Pull-Up Bar Competition</title>
    <style>
      @import url("https://use.typekit.net/dhj1fzt.css");
      h1,
      h2,
      h3,
      p {
        font-family: "trebuchet ms", sans-serif;
        font-weight: 400;
        font-style: normal;
        font-weight: bold;
      }

      h2,
      #average-time {
        color: #ff0000;
      }
      .body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .main-wrapper {
        height: 100%;
        width: 85%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 70px 50px 70px;
      }

      #average-time {
        font-size: 24px;
        font-weight: bold;
      }

      .average-time {
        display: none;
      }

      .interactive-part {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: -120px;
      }

      .input_form {
        width: 103%;
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: -85px;
      }

      .title-big {
        width: 102%;
        color: #ff0000;
        font-size: 140pt;
        text-align: center;
        font-family: "trebuchet ms", sans-serif;
        font-weight: 400;
        font-style: normal;
        font-weight: bold;
        letter-spacing: 30px;
      }

      .title-small {
        font-size: 60pt;
        align-self: flex-start;
        text-align: right;
        margin-left: -45px;
        padding: 30px 0px;
      }
      .name-input {
        width: 101%;
        height: 110px;
        background-color: #eb2136;
        padding: 12px 12px;
        font-size: 66pt;
        text-align: center;
        color: #ffffff;
      }

      .name-input::placeholder {
        color: #ffffff;
        font-size: 66pt;
      }

      .counter-body {
        width: 100%;
        height: 140px;
        background-color: #eb2136;
        text-align: center;
        align-content: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        padding: 20px 35px 15px 35px;
        font-size: 62pt;
        font-weight: 900;
        font-style: bold;
        letter-spacing: 50px;
      }

      .time-slots-table-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        margin-top: -110px;
      }

      .slots-holder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10;
        margin-top: -70px;
      }

      .time-slot-wrapper {
        width: 100%;
        height: 150px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background-color: #eb2136;
        margin-bottom: 40px;
        padding: 0px 40px 0px 42px;
        color: #ffffff;
      }

      .name-time-holder {
        width: 47%;
        height: 90%;
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .medal-holder {
        width: 45%;
        height: 100%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
      }

      .medal-holder-no-medal {
        font-size: 40pt;
        margin-right: 25px;
      }

      .time-slot {
        width: 100%;
        height: 80%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 10px 20px 20px 20px;
        margin-bottom: 30px;
      }

      .time-slot-name,
      .time-slot-time {
        width: 100%;
        height: 10%;
        color: white;
      }

      .name-time-holder {
        font-size: 61pt;
      }

      .medal-picture {
        width: 21%;
        height: 79%;
        margin-right: 0px;
        align-content: flex-end;
      }

      .time-slot-name {
        width: 120%;
        font-size: 36pt;
      }

      .time-slot-time {
        font-size: 21pt;
        margin-top: -6px;
      }

      ul {
        list-style-type: none;
      }

      .disclaimer-image {
        width: 440px;
        height: 60px;
        align-self: flex-end;
        margin-right: -40px;
      }
    </style>
  </head>

  <body class="body">
    <!--
    <h2>ESP Image Web Server</h2>
    <img src="gold" />
    <img src="silver" />
    <img src="bronze" />
    <img src="disclaimer" />
    -->
    <div class="main-wrapper">
      <h1 class="title-big" id="title">DIN TID</h1>
      <!-- Add form for entering player name -->
      <div class="interactive-part">
        <form class="input_form" id="player-form">
          <input
            class="name-input"
            type="text"
            id="player-name"
            name="player-name"
            placeholder="NAVN EFTERNAVN"
          /><br /><br />
        </form>

        <h1 class="counter-body" id="counter">00.00.00</h1>
        <div class="time-slots-table-wrapper">
          <h2 class="title-small">DAGENS TOP 5</h2>
          <div class="slots-holder" id="recorded-times">
            <div class="time-slot-wrapper">
              <div class="name-time-holder" id="time-1">
                <div class="time-slot">
                  <p class="time-slot-name">NAVN EFTERNAVN</p>
                  <p class="time-slot-time">00.00.00</p>
                </div>
              </div>
              <div class="medal-holder">
                <img class="medal-picture" src="assets/Medal_first_place.png" />
              </div>
            </div>
            <div class="time-slot-wrapper">
              <div class="name-time-holder" id="time-2">
                <div class="time-slot">
                  <p class="time-slot-name">NAVN EFTERNAVN</p>
                  <p class="time-slot-time">00.00.00</p>
                </div>
              </div>
              <div class="medal-holder">
                <img
                  class="medal-picture"
                  src="assets/Medal_second_place.png"
                />
              </div>
            </div>
            <div class="time-slot-wrapper">
              <div class="name-time-holder" id="time-3">
                <div class="time-slot">
                  <p class="time-slot-name">NAVN EFTERNAVN</p>
                  <p class="time-slot-time">00.00.00</p>
                </div>
              </div>
              <div class="medal-holder">
                <img class="medal-picture" src="assets/Medal_third_place.png" />
              </div>
            </div>
            <div class="time-slot-wrapper">
              <div class="name-time-holder" id="time-4">
                <div class="time-slot">
                  <p class="time-slot-name">NAVN EFTERNAVN</p>
                  <p class="time-slot-time">00.00.00</p>
                </div>
              </div>
              <div class="medal-holder medal-holder-no-medal">4</div>
            </div>
            <div class="time-slot-wrapper">
              <div class="name-time-holder" id="time-5">
                <div class="time-slot">
                  <p class="time-slot-name">NAVN EFTERNAVN</p>
                  <p class="time-slot-time">00.00.00</p>
                </div>
              </div>
              <div class="medal-holder medal-holder-no-medal">5</div>
            </div>
          </div>
          <img class="disclaimer-image" src="assets/disclaimer.png" />
        </div>
      </div>
      <h2 class="average-time">Average Time</h2>
      <p style="display: none" class="average-time" id="average-time">0</p>
    </div>

    <!-- <== SCRIPT STARTS HERE ==> -->

    <script>
      var count = 0;
      var intervalId;
      var total = 0;
      var timesRecorded = 0; // initialize to 0
      var recordedTimes = [];

      // Connect to the ESP32's WebSocket server
      var socket = new WebSocket("ws://" + location.host + "/ws");

      // Listen for messages from the ESP32
      socket.onmessage = function (event) {
        // If the message is "start", start counting
        if (event.data == "start") {
          count = 0;
          intervalId = setInterval(function () {
            count += 0.01; // increment count by 0.01 seconds

            // Calculate minutes, seconds, and milliseconds
            var minutes = Math.floor(count / 60);
            var seconds = Math.floor(count % 60);
            var milliseconds = Math.floor((count % 1) * 1000);

            // Format the time display with leading zeros
            var timeDisplay =
              ("0" + minutes).slice(-2) +
              "." +
              ("0" + seconds).slice(-2) +
              "." +
              ("0" + milliseconds).slice(-2);

            document.getElementById("counter").innerHTML = timeDisplay; // update counter with formatted time
          }, 10); // update the count every 10 milliseconds
        }

        // If the message is "stop", stop counting and add the time to the list
        else if (event.data == "stop") {
          count += 0.0; // stop the increment

          // Calculate minutes, seconds, and milliseconds
          var minutes = Math.floor(count / 60);
          var seconds = Math.floor(count % 60);
          var milliseconds = Math.floor((count % 1) * 1000);

          // Format the time display with leading zeros
          var timeDisplay =
            ("0" + minutes).slice(-2) +
            "." +
            ("0" + seconds).slice(-2) +
            "." +
            ("0" + milliseconds).slice(-2);

          document.getElementById("counter").innerHTML = timeDisplay;
          setTimeout(function () {
            count = 0;
            document.getElementById("counter").innerHTML = "00.00.00"; // update counter on the web page
            document.getElementById("player-name").value = ""; // Reset the name after 10 seconds
          }, 10000);

          clearInterval(intervalId);

          // Get the player name entered in the form
          var playerName = document.getElementById("player-name").value;

          // If no player name was entered, use a default name
          if (!playerName) {
            playerName = "Anonymous";
          }

          // Add the recorded time and player name to the array
          recordedTimes.push({ time: count, player: playerName });

          // Sort the array in descending order
          recordedTimes.sort(function (a, b) {
            return b.time - a.time;
          });

          // if the recorded times array has more than 5 elements,
          // remove the 6th longest time to keep only the top 5 times
          if (recordedTimes.length > 5) {
            recordedTimes = recordedTimes.slice(0, 5);
          }

          // Display the top 5 longest recorded times with player names
          for (var i = 0; i < 5; i++) {
            var timeElement = document.getElementById("time-" + (i + 1));
            if (i < recordedTimes.length) {
              // Calculate minutes, seconds, and milliseconds
              var minutes = Math.floor(recordedTimes[i].time / 60);
              var seconds = Math.floor(recordedTimes[i].time % 60);
              var milliseconds = Math.floor((recordedTimes[i].time % 1) * 1000);

              // Format the time display with leading zeros
              var timeDisplay =
                ("0" + minutes).slice(-2) +
                "." +
                ("0" + seconds).slice(-2) +
                "." +
                ("0" + milliseconds).slice(-2);

              timeElement.innerHTML = `<div class="time-slot">
          <p class="time-slot-name">${recordedTimes[i].player}</p>
          <p class="time-slot-time">${timeDisplay}</p>
          </div>`;
            } else {
              timeElement.innerHTML = `<div class="time-slot">
                <p class="time-slot-name">NAVN EFTERNAVN</p>
                <p class="time-slot-time">00.00.00</p>
                </div>`;
            }
          }

          // Calculate average time
          timesRecorded++; // always increment when a new time is added
          total += count;
          if (timesed > 0) {
            var average = total / timesRecorded;
            document.getElementById("average-time").innerHTML =
              average.toFixed(2);
          } else {
            // If there are no times recorded, reset the total time
            total = 0;
          }

          // Reset the counter
          count = 0;
          document.getElementById("counter").innerHTML = "00.00.00";

          // Notify the ESP32 that the time has been recorded
          socket.send("recorded");
        }
      };

      // Send a message to the ESP32 to start the competition when the page loads
      window.addEventListener("load", function () {
        socket.send("start");
      });

      // Listen for form submissions
      var form = document.getElementById("player-form");
      form.addEventListener("submit", function (event) {
        event.preventDefault(); // prevent the form from reloading the page

        // Get the name from the form and clear the input field
        var nameInput = document.getElementById("name-input");
        var name = nameInput.value.trim();
        nameInput.value = "";

        // If no name was entered, use a default name
        if (name.length === 0) {
          name = "Anonymous";
        }

        // Send the name to the ESP32 via WebSocket
        socket.send("name:" + name);
      });
    </script>
  </body>
</html>
